## 集群管理

[返回目录](./README.md)

### 功能介绍

集群信息的增删该查，以及集群的启动、停止、升级/部署。  
流程有先后顺序，用户在 创建集群 或 修改集群 时需要点击 保存集群 才能进行启动、停止、升级/部署操作。  
页面在初始化的时候，需要先获得集群的2个状态分别为 是否成功安装 是否成功启动 显示在左侧列表  
在没有保存集群前，相关的操作按钮要设为不可用状态。  
同一时间只能一个集群启动，如果已经有集群启动了，再去启动新的集群此时要提示失败并告诉用户如果想启动新的集群，请先停止已经运行的集群。  
集群的启动是异步的，启动后会马上返回成功启动，需要前端定时去调用执行结果信号接口，来判断是否 执行结束 与 执行成功或失败。　
执行的同时后端会提供一个分页查看日志的接口，前端可以定时调用分页接口，以在页面显示字幕滚动的效果。　

页面布局:  

页面分为两部分,左侧为列表部分,右侧为编辑部分

流程简述:   

- 初始化流程  
  如果已经有集群在启动,左侧列表会为已经启动的集群标上一个绿灯标志,右侧编辑部分则直接显示该集群的内容;  
  如果没有,左侧不显示绿灯,右侧显示空白;  
- 操作流程  
  用户在点击创建集群后,在弹窗里输入集群名字和备注,点击确定;  
  此时右侧的编辑部分则为刚才创建的集群的编辑部分,用户可以继续后面的编辑,只有当最后用户点击保存集群时,左侧列表才追加一条刚才添加的集群;  
  有3个注意事项  
  1 如果用户在编辑其他集群,此时再点创建集群要提醒用户是否保存还是放弃;  
  2 用户在没有保存集群之前,启动/停止/部署按钮均不可操作,只有在保存了才可以操作;  
  3 删除集群需要给用户二段确认,防止误删.并且已经在启动的集群不允许删除,这块逻辑后端有写,直接调用会返回错误;  

集群有如下状态:

- 启动成功 startsuccess
- 启动失败 startfailure
- 停止成功 stopsuccess
- 停止失败 stopfailure
- 部署成功 deploysuccess
- 部署失败 deployfailure
- 准备     prepare
- 取消     cancel

状态流程解释:

- 创建成功后的集群是 准备(prepare) 状态;
- 部署集群成功后状态为 部署成功 (deploysuccess) 如果此时想编辑集群,请点击取消按钮,状态会变为取消 (cancel);
- 点击取消按钮相跟编辑最后的确认流程差不多,前端只是将整个大json中的状态修改成取消并一起传过来;
- 只有在 取消(cancel) 或 停止成功(stopsuccess) 或 部署失败 (deployfailure) 状态下,集群才能进行编辑, 编辑成功会将状态改为准备(prepare);
- 只有在 准备(prepare) 或 停止成功(stopsuccess) 或 部署失败 (deployfailure) 状态下才可以执行部署集群;

状态权限解释:

- 准备 (prepare) 状态下,只能进行部署集群 或 删除集群;
- 取消 (cancel) 状态下,只能进行编辑集群;
- 部署成功 (deploysuccess) 状态下,只能进行启动集群 或 停止集群 或 删除集群;
- 部署失败 (deployfailure) 状态下,只能进行部署集群 或 编辑集群 或 删除集群;
- 启动成功 (startsuccess) 状态下,只能进行停止集群;
- 启动失败 (startfailure) 状态下,只能进行启动集群 或 删除集群;
- 停止成功 (stopsuccess) 状态下,只能进行编辑集群 或 部署集群 或 删除集群;
- 停止失败 (stopfailure) 状态下,只能进行停止集群;


### 接口介绍

配置管理功能有6个接口  
创建/修改集群接口  
删除集群接口  
查询集群列表接口  
执行集群接口  
查看日志接口  
执行结果信号接口

## 创建集群接口

### 英文名

createCluster

### 解释

创建集群信息。  
创建的时候用户可以选择已有的配置进行快速填写，这里只是将已经创建好的配置模板，快速添加到编写角色信息编辑中  
前端的流程，页面初始化的时候会调用各类配置的查询列表接口(列表接口会返回所有数据,前端需要将数据都缓存到 选择配置模板 下拉列表中)，用户在编辑角色信息的时候，可以在 选择配置模板 下拉列表中，选择自己需要的配置进行快速添加

### 接口类型

```
POST
/api/v1/createCluster
Content-Type:application/json
```

### 请求body

```json
{
  "name": "myTest1",
  "hosts": [
    "192.167.8.141"
  ],
  "base": {
    "version": "1.2.0",
    "deployUser": "easy",
    "deployDir": "/home/easy/ds"
  },
  "roles": [
    {
      "roleName": "database",
      "roleBody": {
        "databaseType": "mysql",
        "databaseName": "dolphinscheduler",
        "account": "easy",
        "password": "easy"
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "backend",
      "roleBody": {
        "serverPort": 12345
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "frontend",
      "roleBody": {
        "escProxyPort": 8888
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "master",
      "roleBody": {
        "masterReservedMemory": 0.5
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "worker",
      "roleBody": {
        "workerReservedMemory": 0.5
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "alert",
      "roleBody": {
        "alertType": "mail",
        "mailSender": "feloxx@163.com",
        "mailUser": "feloxx@163.com",
        "mailPasswd": "Chevalier1!",
        "mailServerHost": "smtp.1633.com",
        "mailServerPort": 25,
        "mailSmtpSslEnable": false,
        "mailSmtpStarttlsEnable": false
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "zookeeper",
      "roleBody": null,
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "hadoop",
      "roleBody": {
        "fsDefaultFS": "file:///home/easy/ds/backend/dolphinscheduler_resource"
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    },
    {
      "roleName": "common",
      "roleBody": {
        "dataStore2hdfsBasepath": "file:///home/easy/ds/backend/dolphinscheduler_resource"
      },
      "roleDependHost": [
        "192.167.8.141"
      ]
    }
  ],
  "remark": "ansible test 1"
}
```

### 请求字段解释

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
roleName|string|true| |角色名字，取值范围【frontend，backend，alert，master，worker，database，hadoop，common，zookeeper】
roleBody|object|true| |角色配置内容，对应具体配置
roleDependHost|array|true| |角色依赖host列表
workStatus|bool|true| |集群工作状态，是否启动
deployStatus|bool|true| |集群部署状态，是否部署
version|string|true| |集群版本，只能1.2.0版本以上，老版本不兼容
deployUser|string|true|easy|部署用户，前端界面写死，第一个版本只能是叫easy
deployDir|string|true|/home/easy/ds|部署目录，如果没有特殊要求请使用默认目录
roles|array|true| |角色列表
escProxyPort|int|true| |前端端口
serverPort|int|true| |后端端口
alertType|string|true| |告警类型，小写，取值范围【mail，weixin】
mailSender|string|true| |邮件发送人
mailUser|string|true| |邮件帐号
mailPasswd|string|true| |邮件密码
mailServerHost|string|true| |邮件发送服务器
mailServerPort|int|true| |邮件发送端口
mailSmtpSslEnable|bool|true| |开启邮件ssl协议
mailSmtpStarttlsEnable|bool|true| |开启邮件tls协议
masterReservedMemory|float|true| |master内存
workerReservedMemory|float|true| |worker内存
databaseType|string|true| |数据库类型，小写，取值范围【mysql，postgresql】
databaseName|string|true| |数据库名，建议使用 dolphinscheduler
account|stirng|true| |数据库帐号
password|string|true| |数据库密码
remark|string|false| |备注
dataStore2hdfsBasepath|string|true| |资源中心上传路径
fsDefaultFS|string|true| |hadoop资源目录

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": null
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "插入失败！｛错误信息｝",
  "result": null
}
```

### 响应字段解释   

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||

## 删除集群接口

### 英文名

deleteCluster

### 解释

根据集群id，删除集群

### 接口类型

```
POST
/api/v1/deleteCluster
Content-Type:application/json
```

### 请求body 

```json
{
  "id": "fb03ea72"
}
```

### 请求字段解释  

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
id|string|true||集群id

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": null
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "删除失败！｛错误信息｝",
  "result": null
}
```

### 响应字段解释

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无| | | |

## 查询具体集群

### 英文名

selectCluster

### 解释

根据集群id，返回集群信息

### 接口类型

```
POST
/api/v1/selectCluster
Content-Type:application/json
```

### 请求body 

```json
{
  "id": "894064de"
}
```

### 请求字段解释  

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
id | string | true | | 集群id

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "id": "9df5a945",
    "name": "myTest1",
    "status": "startsuccess",
    "hosts": [
      "192.167.8.141"
    ],
    "base": {
      "version": "1.2.0",
      "deployUser": "easy",
      "deployDir": "/home/easy/ds"
    },
    "roles": [
      {
        "roleName": "database",
        "roleBody": {
          "account": "easy",
          "databaseName": "dolphinscheduler",
          "databaseType": "mysql",
          "password": "easy"
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "backend",
        "roleBody": {
          "serverPort": 12345
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "frontend",
        "roleBody": {
          "escProxyPort": 8888
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "master",
        "roleBody": {
          "masterReservedMemory": 0.5
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "worker",
        "roleBody": {
          "workerReservedMemory": 0.5
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "alert",
        "roleBody": {
          "alertType": "mail",
          "mailPasswd": "邮箱密码",
          "mailSender": "邮箱",
          "mailServerHost": "smtp.163.com",
          "mailServerPort": 25,
          "mailSmtpSslEnable": false,
          "mailSmtpStarttlsEnable": false,
          "mailUser": "发送人"
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "zookeeper",
        "roleBody": null,
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "hadoop",
        "roleBody": {
          "fsDefaultFS": "file:///home/easy/ds/backend/dolphinscheduler_resource"
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      },
      {
        "roleName": "common",
        "roleBody": {
          "dataStore2hdfsBasepath": "file:///home/easy/ds/backend/dolphinscheduler_resource"
        },
        "roleDependHost": [
          "192.167.8.141"
        ]
      }
    ],
    "remark": "ansible test 1"
  }
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "查询失败！｛错误内容｝",
  "result": null
}
```

### 响应字段解释   

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
id|string|true| |集群id
roleName|string|true| |角色名字，取值范围【frontend，backend，alert，master，worker，database，hadoop，common，zookeeper】
roleBody|object|true| |角色配置内容，对应具体配置
roleDependHost|array|true| |角色依赖host列表
workStatus|bool|true| |集群工作状态，是否启动
deployStatus|bool|true| |集群部署状态，是否部署
roles|array|true| |角色列表
escProxyPort|int|true| |前端端口
serverPort|int|true| |后端端口
alertType|string|true| |告警类型，小写，取值范围【mail，weixin】
mailSender|string|true| |邮件发送人
mailUser|string|true| |邮件帐号
mailPasswd|string|true| |邮件密码
mailServerHost|string|true| |邮件发送服务器
mailServerPort|int|true| |邮件发送端口
mailSmtpSslEnable|bool|true| |开启邮件ssl协议
mailSmtpStarttlsEnable|bool|true| |开启邮件tls协议
masterReservedMemory|float|true| |master内存
workerReservedMemory|float|true| |worker内存
databaseType|string|true| |数据库类型，小写，取值范围【mysql，postgresql】
databaseName|string|true| |数据库名，建议使用 dolphinscheduler
account|stirng|true| |数据库帐号
password|string|true| |数据库密码
remark|string|false| |备注
dataStore2hdfsBasepath|string|true| |资源中心上传路径
fsDefaultFS|string|true| |hadoop资源目录

## 查询集群列表接口

### 英文名

selectClusterList

### 解释

查询集群列表，返回集群列表信息。根据列表中的id去查询对应的集群信息。
页面初始化的时候调用该接口，获取列表中带有默认的id，由此来显示默认集群信息。

### 接口类型

```
GET
/api/v1/selectClusterList
```

### 请求body

```
http://192.167.8.141:38888/api/v1/selectClusterList?page=1
```

### 请求字段解释  

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
page|int|true| |分页数

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "currentPage": 1,
    "total": 1,
    "data": [
      {
        "id": "9df5a945",
        "name": "myTest1",
        "status": "deploysuccess",
        "hosts": [
          "192.167.8.141"
        ],
        "base": {
          "version": "1.2.0",
          "deployUser": "easy",
          "deployDir": "/home/easy/ds"
        },
        "roles": [
          {
            "roleName": "database",
            "roleBody": {
              "account": "easy",
              "databaseName": "dolphinscheduler",
              "databaseType": "mysql",
              "password": "easy"
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "backend",
            "roleBody": {
              "serverPort": 12345
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "frontend",
            "roleBody": {
              "escProxyPort": 8888
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "master",
            "roleBody": {
              "masterReservedMemory": 0.5
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "worker",
            "roleBody": {
              "workerReservedMemory": 0.5
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "alert",
            "roleBody": {
              "alertType": "mail",
              "mailPasswd": "邮箱密码",
              "mailSender": "邮箱",
              "mailServerHost": "smtp.163.com",
              "mailServerPort": 25,
              "mailSmtpSslEnable": false,
              "mailSmtpStarttlsEnable": false,
              "mailUser": "邮箱"
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "zookeeper",
            "roleBody": null,
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "hadoop",
            "roleBody": {
              "fsDefaultFS": "file:///home/easy/ds/backend/dolphinscheduler_resource"
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          },
          {
            "roleName": "common",
            "roleBody": {
              "dataStore2hdfsBasepath": "file:///home/easy/ds/backend/dolphinscheduler_resource"
            },
            "roleDependHost": [
              "192.167.8.141"
            ]
          }
        ],
        "remark": "ansible test 1"
      }
    ]
  }
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "查询失败！｛错误内容｝",
  "result": null
}
```

### 响应字段解释   

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
currentPage|int| | |当前页
total|int| | |集群总数
data|object| | |集群内容

## 执行集群接口

### 英文名

executeCluster

### 解释

执行集群相关操作，启动集群，停止集群，部署/升级集群。
执行后是马上返回【成功开始执行】的响应，判断是否【执行成功】请调用【执行结果信号接口】接口获得结果信号。
设计是成功开始执行后，前端准备个定时器每隔5秒调用【执行结果信号接口】来获得执行结果，此时其他操作均不能操作。
同一时间只能进行一个动作。

### 接口类型

```
POST
/api/v1/executeCluster
Content-Type:application/json
```

### 请求body 

```json
{
  "executeType": 0,
  "clusterId": "894064de"
}
```

### 请求字段解释  

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
executeType|string|true| |执行类型【0：启动集群】【1：停止集群】【2：部署/升级集群】
clusterId|string|true| |集群id

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": null
}
```

`响应body` 失败逻辑

```
无
```

### 响应字段解释   

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无||||

## 查看日志接口

### 英文名

readLog

### 解释

分页查看【上一次】执行的日志，每页默认是10条，上一次的执行有多种类型，有可能是启动集群、停止集群、安装升级集群等。
这里的设计是只能查看上一次的操作日志，如果想以资源目录的形式查看，请到服务器中用命令行查看。或者下个迭代再考虑。

### 接口类型

```
GET
/api/v1/readLog
```

### 请求body 

```
http://0.0.0.0:15523/api/v1/readLog?page=1
```

### 请求字段解释  

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
page|int|true||分页数

`响应body` 成功逻辑

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "currentPage": 2,
    "rows": 12592,
    "data": [
      "2020-02-10 16:21:16,124 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,128 p=7999 u=easy |  TASK [check_config_static : ensure api host exists] ****************************",
      "2020-02-10 16:21:16,140 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,145 p=7999 u=easy |  TASK [check_config_static : ensure nginx host exists] **************************",
      "2020-02-10 16:21:16,156 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,160 p=7999 u=easy |  TASK [check_config_static : check ansible_user variable] ***********************",
      "2020-02-10 16:21:16,171 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,175 p=7999 u=easy |  TASK [check_config_static : check ansible version] *****************************",
      "2020-02-10 16:21:16,187 p=7999 u=easy |  skipping: [localhost]",
      "2020-02-10 16:21:16,191 p=7999 u=easy |  TASK [check_config_static : check if jmespath installed] ***********************"
    ]
  }
}
```

`响应body` 失败逻辑

```json
{
  "code": 500,
  "message": "查看日志失败！｛错误内容｝",
  "result": null
}
```

### 响应字段解释   

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
currentPage|int| | |当前页数
rows|int| | |总行数
data|string| | |日志内容

## 执行结果信号接口

### 英文名

executeResultSignal

### 解释

获得 上一次 执行结果信号  
接口会返回 上一次的执行类型,是否执行结束,是否执行成功

### 接口类型

```
GET
/api/v1/executeResultSignal
```

### 请求body 

```
http://192.167.8.141:38888/api/v1/executeResultSignal
```

### 请求字段解释  

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
无| | | |

`响应body` 成功逻辑 表示程序执行 结束 且执行成功

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "singnalType": "deployupdate",
    "success": true,
    "over": true
  }
}
```

`响应body` 成功逻辑 表示程序执行 未结束

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "singnalType": "deployupdate",
    "success": false,
    "over": false
  }
}
```

`响应body` 失败逻辑 表示程序执行 结束 且执行未成功

```json
{
  "code": 200,
  "message": "ok",
  "result": {
    "singnalType": "deployupdate",
    "success": false,
    "over": true
  }
}
```

### 响应字段解释   

字段名|字段类型|是否必填|默认值|字段解释
--- | --- | --- | --- | ---
singnalType|string| | |执行类型,取值范围[start,stop,delopyupdate]
success|bool| | |执行是否成功
over|bool| | |执行是否结束


[返回目录](./README.md)